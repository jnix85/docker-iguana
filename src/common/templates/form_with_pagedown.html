<!--
Iguana (c) by Marc Ammon, Moritz Fickenscher, Lukas Fridolin,
Michael Gunselmann, Katrin Raab, Christian Strate

Iguana is licensed under a
Creative Commons Attribution-ShareAlike 4.0 International License.

You should have received a copy of the license along with this
work. If not, see <http://creativecommons.org/licenses/by-sa/4.0/>.
-->
{% load i18n %}
{% load static %}
{% load bootstrap3 %}
{% load markdown_data %}


{# display the form #}
{% if form.fields|length > 1 %}
    {% bootstrap_form form %}
{% else %}
    {# do not display the title if more than one field is in the form #}
    {% bootstrap_form form layout='inline' %}
{% endif %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static "css/tribute.css" %}" />
    <style>
        .tribute-container ul {
            background: inherit;
        }
    </style>
{% endblock %}
{% block extra_script %}
    {{ form.media }}
    <script src="{% static "js/tribute.min.js" %}"></script>
    {{ project|get_issue_markdown_data|json_script:"issue_markdown_data" }}
    {{ project|get_user_markdown_data|json_script:"user_markdown_data" }}
    <script>
    $(document).ready(function(){
        function remoteSearch(text, queryURL, cb) {
            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        cb(data.results);
                    } else {
                        cb([]);
                    }
                }
            };
            xhr.open("GET", queryURL + "?q=" + text, true);
            xhr.send();
        }

        var tribute = new Tribute({
            collection: [
                {
                    containerClass: 'tribute-container dropdown-menu',
                    trigger: '@',
                    values: function (text, cb) {
                        var URL = "/project/userac/" + "{{ project.name_short }}" + "/";
                        remoteSearch(text, URL, users => cb(users));
                    },
                    selectTemplate: function (item) {
                        // extract user name via regex
                        var userData = JSON.parse(document.getElementById("user_markdown_data").textContent);
                        // the markdown pattern assumes a '@' character before the username, but autocomplete serves the username without '@'
                        // -> remove all '@'s from the pattern
                        var regexPattern = userData.re_pattern.replace(/@/g, '');
                        var re = new RegExp(regexPattern);
                        return '@' + re.exec(item.original.text)[0];
                    },
                    menuItemTemplate: function (item) {
                        return item.original.text;
                    },
                    lookup: "text",
                    fillAttr: "text",
                },
                {
                    containerClass: 'tribute-container dropdown-menu',
                    trigger: "{{ project.name_short }}-",
                    values: function (text, cb) {
                        var URL = "/project/issueac/" + "{{ project.name_short }}" + "/";
                        remoteSearch(text, URL, issues => cb(issues));
                    },
                    selectTemplate: function (item) {
                        // extract issue name via regex
                        var issueData = JSON.parse(document.getElementById("issue_markdown_data").textContent);
                        var re = new RegExp(issueData.re_pattern);
                        return re.exec(item.original.text)[0];
                    },
                    menuItemTemplate: function (item) {
                        return item.original.text;
                    },
                    lookup: "text",
                    fillAttr: "text",
                },
            ]
        });
        tribute.attach(document.querySelectorAll(".wmd-input"));
    });
    </script>
{% endblock %}
